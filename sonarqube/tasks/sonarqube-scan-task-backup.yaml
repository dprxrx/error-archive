apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-scan
  namespace: default
spec:
  description: |
    SonarQube 코드 품질 스캔 Task
    Backend (Node.js) 및 Frontend (JavaScript) 코드 분석
    Secret에서 토큰을 읽거나 직접 토큰을 전달할 수 있습니다.
  params:
  - name: sonarqube-url
    description: SonarQube 서버 URL
    default: http://sonarqube.sonarqube:9000
    type: string
  - name: sonarqube-token
    description: SonarQube 인증 토큰 (직접 전달 시 사용)
    default: ""
    type: string
  - name: sonarqube-token-secret
    description: SonarQube 토큰이 저장된 Secret 이름
    default: ""
    type: string
  - name: sonarqube-token-key
    description: Secret 내 토큰 키 이름
    default: token
    type: string
  - name: project-key
    description: SonarQube 프로젝트 키
    type: string
  - name: project-name
    description: SonarQube 프로젝트 이름
    type: string
  - name: source-path
    description: 스캔할 소스 코드 경로
    default: .
    type: string
  - name: language
    description: 프로그래밍 언어 (js, ts, java 등)
    default: js
    type: string
  workspaces:
  - name: source
    description: 소스 코드 워크스페이스
  steps:
  - name: sonar-scanner
    image: sonarsource/sonar-scanner-cli:latest
    env:
    - name: SONAR_HOST_URL
      value: $(params.sonarqube-url)
    - name: SONAR_PROJECT_KEY
      value: $(params.project-key)
    - name: SONAR_PROJECT_NAME
      value: $(params.project-name)
    script: |
      #!/bin/sh
      set -e
      
      # 토큰 가져오기 (Secret 또는 직접 전달)
      SONAR_TOKEN=""
      
      # Secret에서 토큰 읽기 시도
      if [ -n "$(params.sonarqube-token-secret)" ]; then
        # Kubernetes Secret volume 마운트 경로: /var/secrets/키이름
        TOKEN_FILE="/var/secrets/$(params.sonarqube-token-key)"
        if [ -f "$TOKEN_FILE" ]; then
          SONAR_TOKEN=$(cat "$TOKEN_FILE" | tr -d '\n\r ')
          echo "✅ Secret에서 토큰을 읽었습니다: $(params.sonarqube-token-secret)/$(params.sonarqube-token-key)"
        else
          echo "⚠️ Secret 파일을 찾을 수 없습니다: $TOKEN_FILE"
          echo "   디버깅: /var/secrets 디렉토리 내용:"
          ls -la /var/secrets/ 2>/dev/null || echo "   /var/secrets 디렉토리가 존재하지 않습니다"
        fi
      fi
      
      # Secret에서 읽지 못했고 직접 전달된 토큰이 있으면 사용
      if [ -z "$SONAR_TOKEN" ] && [ -n "$(params.sonarqube-token)" ]; then
        SONAR_TOKEN="$(params.sonarqube-token)"
        echo "✅ 직접 전달된 토큰을 사용합니다."
      fi
      
      if [ -z "$SONAR_TOKEN" ]; then
        echo "❌ SonarQube 토큰이 제공되지 않았습니다."
        echo "   sonarqube-token-secret 또는 sonarqube-token 파라미터를 제공하세요."
        exit 1
      fi
      
      export SONAR_TOKEN
      
      cd $(workspaces.source.path)/$(params.source-path)
      
      # sonar-project.properties 생성
      cat > sonar-project.properties <<EOF
      sonar.projectKey=$(params.project-key)
      sonar.projectName=$(params.project-name)
      sonar.sources=.
      sonar.sourceEncoding=UTF-8
      sonar.host.url=$(params.sonarqube-url)
      sonar.login=$SONAR_TOKEN
      EOF
      
      # 언어별 설정
      if [ "$(params.language)" = "js" ]; then
        echo "sonar.javascript.lcov.reportPaths=coverage/lcov.info" >> sonar-project.properties
        echo "sonar.exclusions=**/node_modules/**,**/dist/**,**/build/**" >> sonar-project.properties
      fi
      
      # SonarQube 스캔 실행
      sonar-scanner
      
      echo "✅ SonarQube 스캔 완료"
    workingDir: $(workspaces.source.path)/$(params.source-path)
    volumeMounts:
    - name: sonarqube-token-secret
      mountPath: /var/secrets
      readOnly: true
  volumes:
  - name: sonarqube-token-secret
    secret:
      secretName: $(params.sonarqube-token-secret)
      optional: true

