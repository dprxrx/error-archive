<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Error Archive - ê¸€ ìƒì„¸ë³´ê¸°</title>

  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/layout.css" />
  <link rel="stylesheet" href="assets/css/post_view.css" />
</head>

<body>
  <header class="nav-bar">
    <div class="nav-left">
      <img src="assets/logo_img.png" alt="Error Archive Logo" class="nav-logo" />
      <a href="list" class="nav-list">Error List</a>
    </div>
    <div class="nav-right">
      <div class="dropdown" id="dropdown-area">
        <button class="nav-link" id="mypage-btn">MY Page â–¾</button>
        <div class="dropdown-content" id="mypage-menu">
          <a href="list?mode=my">ğŸ“ ë‚´ê°€ ì“´ ê¸€</a>
        </div>
      </div>
      <a href="index" class="nav-logout">Log out</a>
    </div>
  </header>

  <main class="post-container">
    <div class="post-header">
      <h2 id="post-title">ë¡œë”© ì¤‘...</h2>
      <div class="post-meta">
        <span id="post-author"></span>
        <span id="post-category"></span>
        <span id="post-date"></span>
      </div>
    </div>

    <div class="post-content">
      <div class="post-section">
        <h4>ğŸ§© ì˜¤ë¥˜ì˜ ë‚´ìš©</h4>
        <div id="error-content"></div>
      </div>
      <div class="post-section">
        <h4>ğŸ’¡ ì˜¤ë¥˜ì˜ í•´ê²°</h4>
        <div id="solution-content"></div>
      </div>
    </div>

    <div class="vote-section" id="vote-section">
      <button class="vote-btn upvote" id="btn-up">ğŸ‘ ì¶”ì²œ <span id="up-count">0</span></button>
      <button class="vote-btn downvote" id="btn-down">ğŸ‘ ë¹„ì¶”ì²œ <span id="down-count">0</span></button>
    </div>

    <div class="action-btns" id="action-btns" style="display:none;"></div>

    <div class="comment-box" id="comment-box">
      <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ ì‘ì„±..." />
      <button id="btn-comment">ë“±ë¡</button>
    </div>

    <div class="comment-list" id="commentList"></div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const userData = JSON.parse(localStorage.getItem("user"));
    const params = new URLSearchParams(window.location.search);
    const postId = params.get("id");

    if (!userData) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = "index";
      return;
    }

    // âœ… ë„¤ë¹„ê²Œì´ì…˜ ì´ë¦„ í‘œì‹œ
    const navRight = document.querySelector(".nav-right");
    const nameTag = document.createElement("span");
    nameTag.textContent = `${userData.name} ë‹˜`;
    nameTag.style.marginRight = "10px";
    navRight.prepend(nameTag);

    // âœ… ë“œë¡­ë‹¤ìš´ ì œì–´
    const btn = document.getElementById("mypage-btn");
    const menu = document.getElementById("mypage-menu");
    btn.addEventListener("click", e => {
      e.stopPropagation();
      menu.classList.toggle("show");
    });
    document.addEventListener("click", e => {
      if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.remove("show");
    });

    try {
      const res = await fetch(`/api/post/${postId}`);
      const post = await res.json();

      // âœ… ì¹´í…Œê³ ë¦¬ ë§¤í•‘
      const categoryMap = {
        1: "ğŸ§ Linux",
        2: "ğŸ’¾ Database",
        3: "ğŸ Python",
        4: "ğŸ³ Docker",
        5: "â˜¸ï¸ Kubernetes",
        6: "â˜ï¸ AWS",
      };

      // âœ… ê²Œì‹œê¸€ ë‚´ìš© í‘œì‹œ
      document.getElementById("post-title").textContent = post.title;
      document.getElementById("post-author").textContent = `ì‘ì„±ì: ${post.author}`;
      document.getElementById("post-category").textContent = `ì¹´í…Œê³ ë¦¬: ${categoryMap[post.category] || "ë¯¸ë¶„ë¥˜"}`;
      document.getElementById("post-date").textContent = `ì‘ì„±ì¼: ${new Date(post.createdAt).toLocaleDateString()}`;
      document.getElementById("error-content").innerHTML = post.errorContent || "(ë‚´ìš© ì—†ìŒ)";
      document.getElementById("solution-content").innerHTML = post.solutionContent || "(ë‚´ìš© ì—†ìŒ)";
      document.getElementById("up-count").textContent = post.likes || 0;
      document.getElementById("down-count").textContent = post.dislikes || 0;

      // âœ… ëŒ“ê¸€ í‘œì‹œ
      const list = document.getElementById("commentList");
      list.innerHTML = "";
      if (post.comments?.length) {
        post.comments.forEach(c => {
          const div = document.createElement("div");
          div.classList.add("comment-item");
          div.innerHTML = `<strong>${c.authorId}</strong><p>${c.content}</p>`;
          list.appendChild(div);
        });
      } else list.innerHTML = "<p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";

      const role = userData.role;
      const voteUp = document.getElementById("btn-up");
      const voteDown = document.getElementById("btn-down");
      const actionArea = document.getElementById("action-btns");

      // âœ… ê´€ë¦¬ì(admin)
      if (role === "admin") {
        document.getElementById("dropdown-area").style.display = "none";
        document.getElementById("comment-box").style.display = "none";
        document.getElementById("commentList").style.display = "none";
        document.getElementById("vote-section").style.display = "none";

        actionArea.style.display = "block";
        actionArea.innerHTML = `
          <button id="btn_ad" class="btn_addel" onclick="approvePost('${postId}')">ìŠ¹ì¸</button>
          <button id="btn_del" class="btn_addel" onclick="deletePost('${postId}')">ì‚­ì œ</button>
        `;
      }

      // âœ… ì‘ì„±ì ë³¸ì¸
      else if (post.author === userData.userId) {
        // ì¶”ì²œ ë¹„í™œì„±í™”
        voteUp.disabled = true;
        voteDown.disabled = true;

        // ëŒ“ê¸€ ë¹„í™œì„±í™”
        document.getElementById("comment-box").style.display = "none";

        // ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        actionArea.style.display = "block";
        actionArea.innerHTML = `
          <button id="btn_ad" class="btn_addel" onclick="editPost('${postId}')">ìˆ˜ì •</button>
          <button id="btn_del" class="btn_addel" onclick="deletePost('${postId}')">ì‚­ì œ</button>
        `;
      }

      // âœ… ì¼ë°˜ ì‚¬ìš©ì
      else {
        actionArea.style.display = "none";
      }

      // âœ… ì¶”ì²œ ê¸°ëŠ¥
      voteUp.addEventListener("click", () => sendVote(postId, "up"));
      voteDown.addEventListener("click", () => sendVote(postId, "down"));

      // âœ… ëŒ“ê¸€ ì¶”ê°€
      document.getElementById("btn-comment").addEventListener("click", async () => {
        const input = document.getElementById("commentInput");
        const text = input.value.trim();
        if (!text) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const res = await fetch(`/api/posts/${postId}/comment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ authorId: userData.userId, content: text })
        });
        const data = await res.json();
        if (data.success) location.reload();
        else alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
      });

    } catch (err) {
      console.error("âŒ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    }
  });

  // âœ… ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
  function editPost(postId) {
    window.location.href = `post_write?id=${postId}&mode=edit`;
  }

  async function sendVote(id, type) {
    const res = await fetch(`/api/post/${id}/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type })
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById("up-count").textContent = data.likes;
      document.getElementById("down-count").textContent = data.dislikes;
    }
  }

  async function approvePost(id) {
    const res = await fetch(`/api/post/${id}/approve`, { method: "POST" });
    const data = await res.json();
    alert(data.message);
    window.location.href = "list";
  }

  async function deletePost(id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const res = await fetch(`/api/post/${id}`, { method: "DELETE" });
    const data = await res.json();
    alert(data.message);
    window.location.href = "list";
  }
  </script>
</body>
</html>


