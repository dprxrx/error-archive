<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Error Archive - ê¸€ ëª©ë¡</title>

  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/list.css">
  <style>
    /* ê²¨ìš¸ ë§ì´ ì´ë²¤íŠ¸ ë°°ë„ˆ */
    #winter-event-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .event-banner-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .event-banner-link {
      background: white;
      color: #667eea;
      padding: 6px 15px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .event-banner-link:hover {
      transform: scale(1.05);
    }

    .event-banner-close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      margin-left: auto;
    }

    .event-banner-close:hover {
      opacity: 0.7;
    }
  </style>
</head>
<body>

  <!-- ê²¨ìš¸ ë§ì´ ì´ë²¤íŠ¸ ë°°ë„ˆ -->
  <div id="winter-event-banner" style="display: none;">
    <div class="event-banner-content">
      <span>ğŸ„ ê²¨ìš¸ ë§ì´ ì´ë²¤íŠ¸ ì§„í–‰ ì¤‘! ë£°ë › ëŒë¦¬ê³  ì„ ë¬¼ ë°›ì! ğŸ</span>
      <a href="roulette" class="event-banner-link">ì°¸ì—¬í•˜ê¸° â†’</a>
      <button class="event-banner-close" onclick="closeEventBanner()">âœ•</button>
    </div>
  </div>

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="nav-bar">
    <div class="nav-left">
      <img src="assets/logo_img.png" alt="Error Archive Logo" class="nav-logo">
      <a href="list" class="nav-list">Error List</a>
    </div>
    <div class="nav-right">
      <div class="dropdown" id="mypage-dropdown">
        <button class="nav-link" id="mypage-btn">MY Page â–¾</button>
        <div class="dropdown-content" id="mypage-menu">
          <a href="list?mode=my">ğŸ“ì˜¤ë‹µë…¸íŠ¸</a>
        </div>
      </div>
      <a href="#" class="nav-logout">Log out</a>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="list-container">
    <div class="list-header">
      <div class="header-left">
        <a href="post_write" class="btn-write">+ ê¸€ì“°ê¸°</a>
      </div>
      <div class="header-right">
        <div class="category-box">
          <label for="category">ì¹´í…Œê³ ë¦¬</label>
          <select id="category" name="category">
            <option value="0">ì „ì²´</option>
            <option value="1">Linux</option>
            <option value="2">Database</option>
            <option value="3">Python</option>
            <option value="4">Docker</option>
            <option value="5">Kubernetes</option>
            <option value="6">AWS</option>
          </select>
        </div>
      </div>
    </div>

    <table class="post-table">
      <thead>
        <tr>
          <th>ì œëª©</th>
          <th>ì¹´í…Œê³ ë¦¬</th>
          <th>ID</th>
          <th>ì‘ì„±ë‚ ì§œ</th>
        </tr>
      </thead>
      <tbody id="post-body">
        <!-- JSì—ì„œ ìë™ìœ¼ë¡œ ì±„ì›Œì§ -->
      </tbody>
    </table>

    <div class="pagination" id="pagination"></div>

    <!-- âœ… ê²€ìƒ‰ ì˜ì—­ -->
    <div class="search-section">
      <hr style="margin: 25px 0;">
      <div class="search-box" style="text-align: center; margin-top: 10px;">
        <select id="search-type" style="padding: 6px; border-radius: 6px;">
          <option value="ì œëª©+ë‚´ìš©">ì œëª©+ë‚´ìš©</option>
          <option value="ì‘ì„±ì">ì‘ì„±ì</option>
        </select>
        <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="padding: 6px; width: 240px; border-radius: 6px; margin-left: 5px;">
        <button id="search-btn" class="btn-search" style="padding: 6px 12px; border-radius: 6px; margin-left: 5px;">ê²€ìƒ‰</button>
        <button id="reset-btn" class="btn-reset" style="padding: 6px 12px; border-radius: 6px; margin-left: 5px;">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    // âœ… JWTê°€ URLì— ìˆì„ ê²½ìš° localStorageì— ì €ì¥
    if (token) {
      localStorage.setItem("jwt", token);
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const decoded = JSON.parse(atob(base64));
        localStorage.setItem("user", JSON.stringify({
          userId: decoded.userId,
          name: decoded.name,
          email: decoded.email,
          role: "user",
          provider: "kakao"
        }));
      } catch (e) {
        console.error("âŒ JWT ë””ì½”ë”© ì‹¤íŒ¨:", e);
      }
      history.replaceState({}, document.title, "list");
    }

    const userData = JSON.parse(localStorage.getItem("user"));
    const mode = params.get("mode");
    const navRight = document.querySelector(".nav-right");
    const btnWrite = document.querySelector(".btn-write");
    const mypageDropdown = document.getElementById("mypage-dropdown");

    if (!userData) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = "index";
      return;
    }

    // âœ… ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
    const nameTag = document.createElement("span");
    nameTag.textContent = `${userData.name} ë‹˜`;
    nameTag.style.marginRight = "10px";
    navRight.prepend(nameTag);

    // âœ… ê²¨ìš¸ ë§ì´ ì´ë²¤íŠ¸ ë°°ë„ˆ í‘œì‹œ (í…Œë§ˆê°€ ê²¨ìš¸ì¼ ë•Œë§Œ)
    const currentTheme = localStorage.getItem('theme') || 'autumn';
    const bannerClosed = localStorage.getItem('eventBannerClosed') === 'true';
    
    if (currentTheme === 'winter' && !bannerClosed) {
      const banner = document.getElementById('winter-event-banner');
      if (banner) {
        banner.style.display = 'block';
      }
    }

    // âœ… ëª¨ë“œë³„ UI í‘œì‹œ ì œì–´
    if (userData.role === "admin" || mode === "my") {
      btnWrite.style.display = "none";
      mypageDropdown.style.display = "none";
    }

    // âœ… ë¡œê·¸ì•„ì›ƒ
    document.querySelector(".nav-logout").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.clear();
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = "index";
    });

    // âœ… ë“œë¡­ë‹¤ìš´ ë©”ë‰´
    const btn = document.getElementById("mypage-btn");
    const menu = document.getElementById("mypage-menu");

    btn?.addEventListener("click", (e) => {
      e.stopPropagation();
      menu.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove("show");
      }
    });

    // âœ… ê²Œì‹œê¸€ ë¡œë“œ
    let posts = [];
    const rowsPerPage = 10;
    let currentPage = 1;

    // âœ… ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë§¤í•‘ í•¨ìˆ˜
    function getCategoryName(code) {
      switch (code) {
        case 1: return "Linux";
        case 2: return "Database";
        case 3: return "Python";
        case 4: return "Docker";
        case 5: return "Kubernetes";
        case 6: return "AWS";
        default: return "ê¸°íƒ€";
      }
    }

    async function fetchPosts() {
      const category = document.getElementById("category").value;
      const role = userData.role;
      const author = userData.userId;

      let url = `api/posts?category=${category}&role=${role}`;
      if (mode === "my") url += `&mode=my&author=${author}`;

      try {
        const res = await fetch(url);
        posts = await res.json();

        displayPosts(currentPage);
        setupPagination();
      } catch (err) {
        console.error("âŒ ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    }

    function displayPosts(page) {
      const postBody = document.getElementById("post-body");
      postBody.innerHTML = "";

      if (!posts.length) {
        postBody.innerHTML = `<tr><td colspan="4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pagePosts = posts.slice(start, end);

      pagePosts.forEach(post => {
        const date = new Date(post.createdAt).toISOString().split("T")[0];
        const categoryName = getCategoryName(post.category);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><a href="post_view?id=${post._id}">${post.title}</a></td>
          <td>${categoryName}</td>
          <td>${post.author}</td>
          <td>${date}</td>
        `;
        postBody.appendChild(row);
      });
    }

    function setupPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      const pageCount = Math.ceil(posts.length / rowsPerPage);
      if (pageCount <= 1) return;

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement("a");
        btn.textContent = i;
        if (i === currentPage) btn.classList.add("active");
        btn.addEventListener("click", () => {
          currentPage = i;
          displayPosts(currentPage);
          setupPagination();
        });
        pagination.appendChild(btn);
      }
    }

    document.getElementById("category").addEventListener("change", () => {
      currentPage = 1;
      fetchPosts();
    });

    // âœ… ê²€ìƒ‰ ê¸°ëŠ¥ (Atlas ê¸°ë°˜)
    document.getElementById("search-btn").addEventListener("click", async () => {
      const keyword = document.getElementById("search-input").value.trim();
      const type = document.getElementById("search-type").value;
      const role = JSON.parse(localStorage.getItem("user")).role; // âœ… ì¶”ê°€
      if (!keyword) {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch(`/api/posts/search?type=${encodeURIComponent(type)}&keyword=${encodeURIComponent(keyword)}`);
        const data = await res.json();

        posts = data;
        currentPage = 1;
        displayPosts(currentPage);
        setupPagination();
      } catch (err) {
        console.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨:", err);
      }
    });

    document.getElementById("reset-btn").addEventListener("click", () => {
      document.getElementById("search-input").value = "";
      fetchPosts();
    });

    // âœ… íŠ¹ì • ëª¨ë“œ(admin, my)ì—ì„œëŠ” ê²€ìƒ‰ì°½ ìˆ¨ê¹€
    const searchSection = document.querySelector(".search-section");
    if ((mode === "my" || userData.role === "admin") && searchSection) {
      searchSection.style.display = "none";
    }

    fetchPosts();
  });

  // ì´ë²¤íŠ¸ ë°°ë„ˆ ë‹«ê¸°
  function closeEventBanner() {
    const banner = document.getElementById('winter-event-banner');
    if (banner) {
      banner.style.display = 'none';
      localStorage.setItem('eventBannerClosed', 'true');
    }
  }

  // âœ… ë’¤ë¡œê°€ê¸° ë°©ì§€
  window.addEventListener("pageshow", (event) => {
    const userData = JSON.parse(localStorage.getItem("user"));
    if (!userData) {
      if (event.persisted) window.location.reload();
      else window.location.href = "index";
    }
  });
</script>

</body>
</html>
