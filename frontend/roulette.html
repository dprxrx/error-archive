<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²¨ìš¸ ë§ì´ ì´ë²¤íŠ¸ - ë£°ë ›</title>
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .roulette-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 500px;
      width: 90%;
    }

    h1 {
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .roulette-wheel {
      width: 300px;
      height: 300px;
      margin: 30px auto;
      position: relative;
      border-radius: 50%;
      border: 10px solid #667eea;
      overflow: hidden;
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
    }

    .roulette-wheel.spinning {
      pointer-events: none;
    }

    .roulette-segment {
      position: absolute;
      width: 50%;
      height: 50%;
      transform-origin: 100% 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      font-size: 16px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .segment-0 { background: #ff6b6b; transform: rotate(0deg); }
    .segment-1 { background: #4ecdc4; transform: rotate(72deg); }
    .segment-2 { background: #ffe66d; transform: rotate(144deg); }
    .segment-3 { background: #95e1d3; transform: rotate(216deg); }
    .segment-4 { background: #f38181; transform: rotate(288deg); }

    .roulette-pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 30px solid #667eea;
      z-index: 10;
    }

    .spin-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 30px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .spin-button:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .spin-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 10px;
      display: none;
    }

    .result.show {
      display: block;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-text {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .back-button {
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
      display: inline-block;
    }

    .history {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      text-align: left;
    }

    .history-item {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    .history-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="roulette-container">
    <h1>ğŸ„ ê²¨ìš¸ ë§ì´ ì´ë²¤íŠ¸ ë£°ë › ğŸ„</h1>
    
    <div class="roulette-wheel" id="roulette-wheel">
      <div class="roulette-pointer"></div>
      <div class="roulette-segment segment-0">ê½</div>
      <div class="roulette-segment segment-1">í”¼ì</div>
      <div class="roulette-segment segment-2">ì¹˜í‚¨</div>
      <div class="roulette-segment segment-3">ì‚¼ê²¹ì‚´</div>
      <div class="roulette-segment segment-4">ì†Œê³ ê¸°</div>
    </div>

    <button class="spin-button" id="spin-button" onclick="spinRoulette()">ë£°ë › ëŒë¦¬ê¸°</button>

    <div class="result" id="result">
      <div class="result-text" id="result-text"></div>
      <p>ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</p>
    </div>

    <div class="history" id="history" style="display: none;">
      <h3>ë‚˜ì˜ ë£°ë › ê²°ê³¼</h3>
      <div id="history-list"></div>
    </div>

    <a href="list" class="back-button">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script>
    const items = ['ê½', 'í”¼ì', 'ì¹˜í‚¨', 'ì‚¼ê²¹ì‚´', 'ì†Œê³ ê¸°'];
    const itemAngles = [0, 72, 144, 216, 288]; // ê° í•­ëª©ì˜ ê°ë„
    let isSpinning = false;

    // ë£°ë › ëŒë¦¬ê¸°
    async function spinRoulette() {
      if (isSpinning) return;
      
      isSpinning = true;
      const button = document.getElementById('spin-button');
      const wheel = document.getElementById('roulette-wheel');
      const result = document.getElementById('result');
      const resultText = document.getElementById('result-text');
      
      button.disabled = true;
      wheel.classList.add('spinning');
      result.classList.remove('show');

      // ëœë¤ ê²°ê³¼ ì„ íƒ
      const randomIndex = Math.floor(Math.random() * items.length);
      const selectedItem = items[randomIndex];
      const baseAngle = itemAngles[randomIndex];
      
      // ë£°ë › íšŒì „ (360ë„ * 5 + ëœë¤ ê°ë„)
      const spins = 5;
      const randomOffset = Math.random() * 72 - 36; // -36 ~ 36ë„ ëœë¤
      const finalAngle = spins * 360 + baseAngle + randomOffset;
      
      wheel.style.transform = `rotate(${finalAngle}deg)`;

      // íšŒì „ ì™„ë£Œ í›„ ê²°ê³¼ í‘œì‹œ
      setTimeout(async () => {
        wheel.classList.remove('spinning');
        resultText.textContent = selectedItem;
        result.classList.add('show');
        
        // ê²°ê³¼ ì €ì¥
        await saveResult(selectedItem);
        
        // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
        await loadHistory();
        
        button.disabled = false;
        isSpinning = false;
      }, 4000);
    }

    // ê²°ê³¼ ì €ì¥
    async function saveResult(item) {
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/';
          return;
        }

        const response = await fetch('/api/roulette/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: user.userId,
            result: item,
            timestamp: new Date().toISOString()
          })
        });

        if (!response.ok) {
          console.error('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜:', error);
      }
    }

    // íˆìŠ¤í† ë¦¬ ë¡œë“œ
    async function loadHistory() {
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) return;

        const response = await fetch(`/api/roulette/history?userId=${user.userId}`);
        if (response.ok) {
          const data = await response.json();
          const historyList = document.getElementById('history-list');
          const historyDiv = document.getElementById('history');
          
          if (data.history && data.history.length > 0) {
            historyDiv.style.display = 'block';
            historyList.innerHTML = data.history.map(item => `
              <div class="history-item">
                <strong>${item.result}</strong> - ${new Date(item.timestamp).toLocaleString('ko-KR')}
              </div>
            `).join('');
          }
        }
      } catch (error) {
        console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = () => {
      loadHistory();
    };
  </script>
</body>
</html>

